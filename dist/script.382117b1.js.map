{"version":3,"sources":["Viewer.js","mandelbrot.js","script.js"],"names":["module","exports","elementId","range","draw","status","div","document","getElementById","cx","x","init","cy","y","scale","canvas","createElement","appendChild","width","clientWidth","height","clientHeight","style","cursor","touchAction","ctx","getContext","fillStyle","strokeStyle","translate","mtXY2IJ","getTransform","mtIJ2XY","invertSelf","updateMatrix","getXY","i","j","a","c","e","b","d","f","getScale","Math","sqrt","clampScale","p","k","max","min","mouse","pointers","info","length","toFixed","si","sj","p0","p1","addEventListener","push","id","pointerId","offsetX","offsetY","setShift","pt","find","ei","ej","di","dj","movingUpdate","movingUpdate2","fixTransform","pointerend","p0s","p0e","p1s","p1e","vsi","vsj","vei","vej","ad","bc","transform","update","window","deltaY","image","Image","save","resetTransform","clearRect","drawImage","restore","src","toDataURL","md","xn","yn","xn1","yn1","m","data","getImageData","index","putImageData","Viewer","require","mandelbrot","vw","str","innerHTML"],"mappings":"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","file":"script.382117b1.js","sourceRoot":"..\\src","sourcesContent":["/*\r\n\tViewer\r\n\t2020/10/26 新規作成\r\n*/\r\n\r\n//表示画面\r\nmodule.exports = function(elementId,range,draw,status){\r\n\t\r\n\tconst div = document.getElementById(elementId);\r\n\t\r\n\t//画面中心の座標(X,Y)\r\n\tlet cx = range.x.init;\r\n\tlet cy = range.y.init;\r\n\t\r\n\t//縮尺[px/1]\r\n\tlet scale = range.scale.init;\r\n\t\r\n\tconst canvas = document.createElement(\"canvas\");\r\n\tdiv.appendChild(canvas);\r\n\twidth = div.clientWidth;\r\n\theight = div.clientHeight;\r\n\tcanvas.width = width;\r\n\tcanvas.height = height;\r\n\t\r\n\tcanvas.style.cursor = \"crosshair\";\r\n\tcanvas.style.touchAction = \"none\";\r\n\t\r\n\tconst ctx = canvas.getContext(\"2d\");\r\n\tctx.fillStyle = \"rgba(0,0,0,1.0)\";\r\n\tctx.strokeStyle = \"rgba(0,0,0,1.0)\";\r\n\t\r\n\tctx.translate(width * 0.5, height * 0.5);\r\n\tctx.scale(scale, -scale);\r\n\tctx.translate(-cx, -cy);\r\n\t\r\n\t//--------------------------------------------------\r\n\t//座標変換\r\n\t//--------------------------------------------------\r\n\t\r\n\tlet mtXY2IJ = ctx.getTransform();\r\n\tlet mtIJ2XY = ctx.getTransform().invertSelf();\r\n\t\r\n\tconst updateMatrix = function(){\r\n\t\tmtXY2IJ = ctx.getTransform();\r\n\t\tmtIJ2XY = ctx.getTransform().invertSelf();\r\n\t};\r\n\t\r\n\tconst getXY = function(i,j){\r\n\t\tconst x = mtIJ2XY.a * i + mtIJ2XY.c * j + mtIJ2XY.e;\r\n\t\tconst y = mtIJ2XY.b * i + mtIJ2XY.d * j + mtIJ2XY.f;\r\n\t\treturn {x,y};\r\n\t};\r\n\t\r\n\tconst getIJ = function(x,y){\r\n\t\tconst i = mtXY2IJ.a * x + mtXY2IJ.c * y + mtXY2IJ.e;\r\n\t\tconst j = mtXY2IJ.b * x + mtXY2IJ.d * y + mtXY2IJ.f;\r\n\t\treturn {i,j};\r\n\t};\r\n\t\r\n\tconst getScale = function(){\r\n\t\treturn Math.sqrt(mtXY2IJ.a * mtXY2IJ.a + mtXY2IJ.b * mtXY2IJ.b);\r\n\t};\r\n\t\r\n\t//--------------------------------------------------\r\n\t//移動拡大制約\r\n\t//--------------------------------------------------\r\n\t\r\n\t//p: 拡大中心位置(XY座標)\r\n\tconst clampScale = function(p){\r\n\t\tupdateMatrix();\r\n\t\t\r\n\t\tlet k = 1;\r\n\t\t\r\n\t\tif(getScale() > range.scale.max){\r\n\t\t\tk = range.scale.max / getScale();\r\n\t\t};\r\n\t\t\t\r\n\t\tif(getScale() < range.scale.min){\r\n\t\t\tk = range.scale.min / getScale();\r\n\t\t};\r\n\t\t\r\n\t\tctx.translate(p.x, p.y);\r\n\t\tctx.scale(k,k);\r\n\t\tctx.translate(-p.x, -p.y);\r\n\t};\r\n\t\r\n\t//--------------------------------------------------\r\n\t//ポインターイベント\r\n\t//--------------------------------------------------\r\n\t\r\n\t//動作中のポインター\r\n\tlet mouse = null;\t//クリックしていない状態のマウス位置（e.pointerId=1となるが、pointersには含めない)\r\n\tlet pointers = [];\t//クリックまたはタップされたポインターの位置\r\n\t\r\n\t//status表示\r\n\tconst info = function(){\r\n\t\tconst scale = getScale();\r\n\t\t\r\n\t\tif(pointers.length == 0){\r\n\t\t\tconst p = getXY(mouse.i,mouse.j);\r\n\t\t\tstatus(\"X=\" + p.x.toFixed(8) + \"<br>Y=\" + p.y.toFixed(8) + \"<br>scale[px/1]=\" + scale.toFixed(1));\r\n\t\t\t\r\n\t\t}else if(pointers.length == 1){\r\n\t\t\tconst p = getXY(pointers[0].si,pointers[0].sj);\r\n\t\t\tstatus(\"X=\" + p.x.toFixed(8) + \"<br>Y=\" + p.y.toFixed(8) + \"<br>scale[px/1]=\" + scale.toFixed(1));\r\n\t\t\t\r\n\t\t}else if(pointers.length == 2){\r\n\t\t\tconst p0 = getXY(pointers[0].si,pointers[0].sj);\r\n\t\t\tconst p1 = getXY(pointers[1].si,pointers[1].sj);\r\n\t\t\tstatus(\"X=\" + p0.x.toFixed(8) + \"<br>Y=\" + p0.y.toFixed(8) + \"<br>X=\" + p1.x.toFixed(8) + \"<br>Y=\" + p1.y.toFixed(8) + \"<br>scale[px/1]=\" + scale.toFixed(1));\r\n\t\t}\r\n\t};\r\n\t\r\n\tcanvas.addEventListener(\"pointerdown\",function(e){\r\n\t\tcanvas.style.cursor = \"move\";\r\n\t\t\r\n\t\tpointers.push({\r\n\t\t\tid: e.pointerId,\r\n\t\t\tsi: e.offsetX,\r\n\t\t\tsj: e.offsetY,\r\n\t\t});\r\n\t\t\r\n\t\tinfo();\r\n\t});\r\n\t\r\n\t//該当するポインターの状態を更新する\r\n\tconst setShift = function(e){\r\n\t\tconst pt = pointers.find(function(p){\r\n\t\t\treturn p.id == e.pointerId;\r\n\t\t});\r\n\t\t\r\n\t\t//最新位置\r\n\t\tpt.ei = e.offsetX;\r\n\t\tpt.ej = e.offsetY;\r\n\t\t\r\n\t\t//移動量\r\n\t\tpt.di = e.offsetX - pt.si;\r\n\t\tpt.dj = e.offsetY - pt.sj;\r\n\t};\r\n\t\r\n\tcanvas.addEventListener(\"pointermove\",function(e){\r\n\t\t\r\n\t\tif(pointers.length == 0){\r\n\t\t\tmouse = {\r\n\t\t\t\ti: e.offsetX,\r\n\t\t\t\tj: e.offsetY,\r\n\t\t\t};\r\n\t\t\t\r\n\t\t}else if(pointers.length == 1){\r\n\t\t\tsetShift(e);\r\n\t\t\tmovingUpdate(pointers[0].di,pointers[0].dj);\r\n\t\t\t\r\n\t\t}else if(pointers.length == 2){\r\n\t\t\tsetShift(e);\r\n\t\t\tmovingUpdate2(pointers[0],pointers[1]);\r\n\t\t}\r\n\t\t\r\n\t\tinfo();\r\n\t});\r\n\t\r\n\t//座標変換を確定させる\r\n\tconst fixTransform = function(){\r\n\t\t\r\n\t\tif(pointers.length == 1){\r\n\t\t\t//p0がp1に一致するように平行移動\r\n\t\t\tconst p0 = getXY(pointers[0].si,pointers[0].sj);\r\n\t\t\tconst p1 = getXY(pointers[0].ei,pointers[0].ej);\r\n\t\t\tctx.translate(p1.x - p0.x,p1.y - p0.y);\r\n\t\t\t\r\n\t\t}else if(pointers.length == 2){\r\n\t\t\t//p0sがp0e、p1sがp1eに一致するように平行移動回転拡大\r\n\t\t\tconst p0s = getXY(pointers[0].si,pointers[0].sj);\r\n\t\t\tconst p0e = getXY(pointers[0].ei,pointers[0].ej);\r\n\t\t\tconst p1s = getXY(pointers[1].si,pointers[1].sj);\r\n\t\t\tconst p1e = getXY(pointers[1].ei,pointers[1].ej);\r\n\t\t\t\r\n\t\t\tctx.translate(p0e.x, p0e.y);\r\n\t\t\t\r\n\t\t\t//p0を中心としてvsがveに一致するように回転拡大する座標変換\r\n\t\t\t//移動前のp0→p1ベクトルvs、移動後のp0→p1ベクトルve\r\n\t\t\tconst vsi = p1s.x - p0s.x;\r\n\t\t\tconst vsj = p1s.y - p0s.y;\r\n\t\t\tconst vei = p1e.x - p0e.x;\r\n\t\t\tconst vej = p1e.y - p0e.y;\r\n\t\t\tconst k = 1 / (vsi * vsi + vsj * vsj);\r\n\t\t\tconst ad = vei * vsi + vej * vsj;\r\n\t\t\tconst bc = vej * vsi - vei * vsj;\r\n\t\t\tctx.transform(ad * k, bc * k, -bc * k, ad * k, 0, 0);\r\n\t\t\t\r\n\t\t\tctx.translate(-p0e.x, -p0e.y);\r\n\r\n\t\t\t//p0の位置を合わせる\r\n\t\t\tctx.translate(p0e.x - p0s.x, p0e.y - p0s.y);\r\n\t\t\t\r\n\t\t\t//ズーム制約\r\n\t\t\tconst cx = (p0s.x + p1s.x) * 0.5;\r\n\t\t\tconst cy = (p0s.y + p1s.y) * 0.5;\r\n\t\t\tclampScale({x:cx, y:cy});\r\n\t\t}\r\n\t\t\r\n\t\tupdateMatrix();\r\n\t}\r\n\t\r\n\t//ポインター終了時の動作\r\n\tconst pointerend = function(e){\r\n\t\tfixTransform();\r\n\t\tupdate();\r\n\t\t\r\n\t\tpointers = [];\r\n\t\t\r\n\t\tcanvas.style.cursor = \"crosshair\";\r\n\t\tinfo();\r\n\t};\r\n\t\r\n\twindow.addEventListener(\"pointerup\",pointerend);\r\n\twindow.addEventListener(\"pointercancel\",pointerend);\r\n\t\r\n\t//--------------------------------------------------\r\n\t//マウスホイールイベント(PC専用)\r\n\t//--------------------------------------------------\r\n\t\r\n\tcanvas.addEventListener(\"wheel\",function(e){\r\n\t\t\r\n\t\t//マウスの位置pを中心にk倍する\r\n\t\tconst p = getXY(e.offsetX,e.offsetY);\r\n\t\tconst k = e.deltaY < 0 ? 1.4 : 1 / 1.4;\r\n\t\t\r\n\t\tctx.translate(p.x,p.y);\r\n\t\tctx.scale(k,k);\r\n\t\tctx.translate(-p.x,-p.y);\r\n\t\t\r\n\t\t//ズームの制約\r\n\t\tclampScale(p);\r\n\t\t\r\n\t\t//確定\r\n\t\tupdateMatrix();\r\n\t\tupdate();\r\n\t\tinfo();\r\n\t});\r\n\t\r\n\t//--------------------------------------------------\r\n\t//描画\r\n\t//--------------------------------------------------\r\n\t\r\n\t//画面に表示された画像(移動中に表示させる)\r\n\tconst image = new Image();\r\n\t\r\n\t//平行移動用(簡略化版)\r\n\tconst movingUpdate = function(di,dj){\r\n\t\t\r\n\t\t//IJ座標系に直して処理\r\n\t\tctx.save();\r\n\t\tctx.resetTransform();\r\n\t\tctx.clearRect(0, 0, width, height);\r\n\t\t\r\n\t\tctx.translate(di, dj);\r\n\t\tctx.drawImage(image,0,0,width,height,0,0,width,height);\r\n\t\t\r\n\t\tctx.restore();\r\n\t};\r\n\t\r\n\t//ピンチインアウト版\r\n\tconst movingUpdate2 = function(p0,p1){\r\n\t\t\r\n\t\t//IJ座標系に直して処理\r\n\t\tctx.save();\r\n\t\tctx.resetTransform();\r\n\t\tctx.clearRect(0, 0, width, height);\r\n\t\t\r\n\t\t//p0sがp0e、p1sがp1eに一致するように平行移動回転拡大\r\n\t\tctx.translate(p0.ei,p0.ej);\r\n\t\t\r\n\t\t//p0を中心としてvsがveに一致するように回転拡大する座標変換\r\n\t\t//移動前のp0→p1ベクトルvs、移動後のp0→p1ベクトルve\r\n\t\tconst vsi = p1.si - p0.si;\r\n\t\tconst vsj = p1.sj - p0.sj;\r\n\t\tconst vei = p1.ei - p0.ei;\r\n\t\tconst vej = p1.ej - p0.ej;\r\n\t\tconst k = 1 / (vsi * vsi + vsj * vsj);\r\n\t\tconst ad = vei * vsi + vej * vsj;\r\n\t\tconst bc = vej * vsi - vei * vsj;\r\n\t\tctx.transform(ad * k, bc * k, -bc * k, ad * k, 0, 0);\r\n\r\n\t\tctx.translate(-p0.ei,-p0.ej);\r\n\r\n\t\t//p0の位置を合わせる\r\n\t\tctx.translate(p0.di,p0.dj);\r\n\t\t\r\n\t\tctx.drawImage(image,0,0,width,height,0,0,width,height);\r\n\t\tctx.restore();\r\n\t};\r\n\t\r\n\tconst update = function(){\r\n\t\t//IJ座標系に直して全画面消去\r\n\t\tctx.save();\r\n\t\tctx.resetTransform();\r\n\t\tctx.clearRect(0, 0, width, height);\r\n\t\tctx.restore();\r\n\t\t\r\n\t\t//XY座標で描画\r\n\t\tdraw(ctx,width,height);\r\n\t\t\r\n\t\t//移動中表示用の画像保存\r\n\t\timage.src = canvas.toDataURL();\r\n\t};\r\n\t\r\n\tupdate();\r\n};","/*\r\n\tマンデルブロ集合\r\n\t2020/10/25 新規作成\r\n*/\r\n\r\nconst md = function(x,y){\r\n\tlet xn = 0;\r\n\tlet yn = 0;\r\n\t\r\n\tfor(let i=0; i<256; i++){\r\n\t\tconst xn1 = xn * xn - yn * yn + x;\r\n\t\tconst yn1 = 2 * xn * yn + y;\r\n\t\txn = xn1;\r\n\t\tyn = yn1;\r\n\t\t\r\n\t\tif(xn * xn + yn * yn > 4) return 256 - i;\r\n\t}\r\n\t\r\n\treturn 0;\r\n};\r\n\r\n\r\nmodule.exports = function(ctx,width,height){\r\n\t//IJ座標からXY座標への変換行列\r\n\tconst m = ctx.getTransform().invertSelf();\r\n\t\r\n\tconst data = ctx.getImageData(0, 0, width, height);\r\n\r\n\tfor(let j=0; j<height; j++){\r\n\t\tfor(let i=0; i<width; i++){\r\n\t\t\tconst index = (i + j * width) * 4;\r\n\t\t\t\r\n\t\t\tconst x = m.a * i + m.c * j + m.e;\r\n\t\t\tconst y = m.b * i + m.d * j + m.f;\r\n\t\t\tconst c = md(x,y);\r\n\t\t\t\r\n\t\t\tdata.data[index] = c; // R\r\n\t\t\tdata.data[index+1] = c; // G\r\n\t\t\tdata.data[index+2] = c; // B\r\n\t\t\tdata.data[index+3] = 255; // A\r\n\t\t}\r\n\t}\r\n\t\r\n\tctx.putImageData(data, 0, 0);\r\n};\r\n","/*\r\n\tmandelbrot\r\n\t2020/10/26 新規作成\r\n*/\r\n\r\nconst Viewer = require(\"./Viewer.js\");\r\nconst mandelbrot = require(\"./mandelbrot.js\");\r\n\r\nconst vw = new Viewer(\"viewer\",{\r\n\t\r\n\tx: {\r\n\t\tinit: -0.5,\r\n\t},\r\n\t\r\n\ty: {\r\n\t\tinit: 0.0,\r\n\t},\r\n\t\r\n\tscale: {\r\n\t\tinit: 100,\r\n\t\tmin: 100,\r\n\t\tmax: 200000000,\r\n\t},\r\n\r\n},function(ctx,width,height){\r\n\t\r\n\tmandelbrot(ctx,width,height);\r\n\t\r\n},function(str){\r\n\t\r\n\tdocument.getElementById(\"status\").innerHTML = str;\r\n\t\r\n});\r\n"]}